# Product Requirements Document (PRD): FiAi Web MVP

## 1. 产品概述

### 1.1 产品定位
FiAi 是一个面向新手的 A 股 AI 辅助投研与策略系统，提供：
- 行情数据（`akshare`：日线/分钟线）与事件文本（公告/财报/新闻/研报等）的采集、结构化与时间对齐
- “可解释”的信号输出（研究与决策支持，不输出具体个股买卖建议）
- 策略回测与策略验证（尽可能贴近真实交易规则的口径）
- 模拟盘执行与回放复盘（先模拟，后预留实盘抽象层）

### 1.2 MVP 目标
- 在 Web 端形成“选股 → 盯盘 → 复盘 → 策略验证/回测 → 规则生成（用于模拟盘）”的闭环
- 所有策略输出必须可解释、可追溯、可复现
- 风控硬约束：最大回撤（Max Drawdown）\( \le 25\% \)，以回测/模拟盘同口径可验证
- 形成可长期迭代的工程化产品骨架（后续可扩展 App/小程序）

### 1.3 重要边界（必须遵守）
- 不提供具体个股“买/卖”投资建议；不承诺盈利；输出为研究与决策支持 + 可配置策略 + 回测/模拟盘验证
- 数据源与使用需考虑合规与授权：公告/研报/新闻抓取与商用许可、行情频率限制与授权约束必须在系统内显式体现（来源白名单与许可标记）

### 1.4 现有工程基础（已存在）
- 前端：`E:\01_Project\FiAi\fronted`（`Vite + React + TS + antd + echarts + zustand`）
  - 页面：`Dashboard`, `StockPage`, `AnalysisHistory`, `Settings`, `Login`, `Register`
  - 组件：`StockChart`, `StockList`, `AIChat`
- 后端：`E:\01_Project\FiAi\backend`（`Django 5 + DRF + JWT + akshare + pandas`）
  - 已有模型：用户 AI 配置、分组自选股、自选股、AI 分析日志

---

## 2. 用户与使用场景

### 2.1 目标用户
- 新手/轻度交易者：希望理解信号来源、风险与失效条件，愿意用“回测/模拟盘”验证规则
- 进阶用户：希望快速搭建可解释策略，并对稳定性与回撤进行约束

### 2.2 核心使用场景（MVP）
- 选股：从股票池筛选到自选分组，并查看“信号/事件/风险标签”
- 盯盘：看到自选标的的事件流与信号时间线，理解触发原因与风险提示
- 复盘：对信号触发当时的证据快照进行复盘，沉淀规则与参数
- 验证：在策略实验室中选择模板→调参→回测→样本外验证→输出“可执行规则草案”

---

## 3. 信息架构（Web MVP 页面与工作流）

### 3.1 页面清单（MVP 必选）
- 工作台 `Dashboard`
  - 今日风险概览（组合/策略层回撤、波动、风险熔断状态）
  - 事件瀑布流（按时间对齐的事件）
  - 待处理提醒（数据缺口/解析失败/反过拟合提醒/回测任务完成）
- 自选&分组 `Watchlist`
  - 分组列表 + 股票表格（可配置列：行业、风格、信号、事件、风险标签）
  - 快速过滤：停牌/ST/流动性不足/数据质量差
- 个股研究 `Stock Page`
  - K 线主图 + 指标叠加 + 事件标注
  - 信号卡片（结构化解释）
  - 历史相似样本（同类信号历史分布）
  - AI 摘要（仅做证据整理与结构化抽取，不做投资建议）
- 策略实验室 `Strategy Lab`
  - 模板选择 → 参数配置 → 回测 → 对比 → 导出规则（用于模拟盘/回放）
- 回测报告 `Backtest Report`
  - 核心指标、稳定性指标、交易明细、风险事件、可复现配置
- 复盘 `Journal / AnalysisHistory`
  - 信号触发当时证据快照、用户笔记、复盘标签（失效原因/执行偏差/数据问题）
- 设置 `Settings`
  - AI Key、数据源许可与免责声明、默认风控阈值、告警渠道（后续）

### 3.2 端到端工作流
1) 选股：证券搜索 → 加入自选分组 → 查看信号/事件/风险列  
2) 盯盘：事件流更新 → 信号触发 → 风险提示分级 →（可选）加入复盘队列  
3) 复盘：打开个股页 → 查看“证据-信号-风控-结果”时间线 → 记录笔记  
4) 验证：策略实验室选择模板 → 调参 → 回测（含样本外）→ 生成规则草案  
5) 规则生成：通过最低门槛后允许启用到模拟盘（禁止直接给出买卖建议）

---

## 4. “新手可用但不误导”的产品机制

### 4.1 默认模式与阻断机制
- 默认进入“研究模式”：只展示证据、概率性语言与风险提示，不提供买卖按钮
- “验证模式”开启条件：必须通过回测最低门槛（含样本外）才可导出可执行规则到模拟盘

### 4.2 风险提示分级（UI 与交互强制）
- L1：轻提醒（信息提示）
- L2：显著提示（需要用户确认继续查看/继续操作）
- L3：阻断（例如缺少样本外验证、数据质量差、回撤约束不满足时禁止启用模拟盘规则）

### 4.3 强制解释（每个信号卡片固定字段）
- 触发因素（规则与阈值）
- 关键证据（指标/价格/事件事实 + 引用来源）
- 历史相似样本（过去 N 次同类触发后分布）
- 风险点（执行风险、数据质量、环境不适配）
- 失效条件（什么情况下规则不再成立/需要退出）

### 4.4 反过拟合提醒（必须呈现）
当出现任一情况，必须在回测报告与策略实验室标红提示：
- 样本外显著变差（例如 Calmar/Sharpe/MaxDD 退化超过阈值）
- 参数敏感（小幅扰动导致收益/回撤剧烈变化）
- 交易次数过少（统计不可信）
- 回撤修复时间过长（体验不适合新手）

---

## 5. UI/交互（参考 finscope 的信息密度风格）

### 5.1 布局原则（MVP）
- 三栏 + 抽屉：左导航/分组，中间主面板（图表/表格），右证据栏（事件/AI/风控），底部抽屉（回测日志/订单流水/错误）
- 面板可折叠与“工作区保存”：至少提供 2 套预置布局（研究/回测）

### 5.2 核心组件（MVP 优先级）
- 多层 K 线图：K 线 + 成交量 + 指标叠加（MA/RSI/MACD/波动率）+ 事件标注点
- 信号时间线：事件 → 特征变化 → 信号 → 风控动作 → 结果，可跳转到对应 K 线位置
- 证据卡片：来源、时间、实体、结构化事实、证据片段、置信度、解析版本
- 相似样本浏览器：展示未来 5/10/20 日收益分布、MAE/MFE、最差情形

---

## 6. 数据层方案（行情 + 分钟线 + 文本事件）

### 6.1 行情数据（akshare）工程流程
- 证券主数据 `instrument`：代码、交易所、名称、上市/退市、ST 区间等
- 交易日历 `trading_calendar`：用于补齐缺失、事件对齐与回放
- 复权策略：不改写原始价，存“原始 + 因子 + 派生视图”
  - `raw`：原始未复权（用于撮合与涨跌停判断的基准，按数据源定义）
  - `adj_factor`：复权因子（可追溯）
  - `qfq/hfq`：研究与指标计算使用（更稳定）
- 分钟线对齐：生成标准分钟索引，缺失分钟标记 `is_missing`，停牌标记 `is_suspended`，严禁用静默填充值参与成交撮合

### 6.2 文本数据（公告/财报/新闻/研报）
- 来源策略：来源白名单 + 授权/许可标记；许可不明默认不抓全文（仅存链接与元信息）
- 去重：`source_url` 精确去重 + 规范化文本 `content_hash` 去重 + 近重复（可选）
- 实体识别与结构化：公司/行业/事件类型（回购、减持、业绩预告、合同、诉讼、处罚等）
- 输出两类可回测产物：
  - 抽取型：结构化事实（数字、范围、主体、时间）
  - 归类型：映射到预定义 taxonomy，并附证据片段（可审计）

### 6.3 事件时间对齐到 K 线（可回测前提）
- 每条事件存两个时间：
  - `event_time`：原始发生/披露时间
  - `market_effective_time`：映射到最近可交易时刻（盘中→下一分钟，盘后→下一交易日开盘前/第一分钟，停牌→复牌第一分钟/第一日）
- 回测必须使用 `market_effective_time`，并启用 `lookahead_guard` 防止未来信息泄漏

### 6.4 存储与索引（MVP 推荐）
- MVP：`PostgreSQL`（SQLite 不适合分钟线与并发任务）
- 索引：时序表 `(symbol, ts)` 复合索引；事件表 `(symbol, market_effective_time)`；全文检索使用 `tsvector`（MVP 足够）
- 冷热分层：近 6–12 个月分钟线为热数据，历史分区/压缩为冷数据；回测按需批量读
- 增量更新：按 `(trading_day, symbol)` 幂等 upsert；写入批次记录 `ingestion_run` 便于回放与审计

---

## 7. 策略与信号体系（可解释优先）

### 7.1 策略模板（MVP 内置：3–5 条）
以下为研究与验证模板，不构成投资建议。所有模板必须给出解释字段与失效条件。

#### S1 趋势跟随（适合趋势市；震荡市易反复止损）
- 入场：收盘价上穿 `MA_fast` 且 `MA_fast > MA_slow`，`ATR%` 不高于阈值
- 出场：跌破 `MA_fast` 或触发 `ATR` 跟踪止损
- 仓位：波动率目标仓位（`target_vol / realized_vol`）+ 单票/行业上限
- 失效条件：趋势强度长期低位、交易频繁且胜率下降

#### S2 突破 + 成交量确认（适合趋势启动；假突破风险高）
- 入场：突破 N 日高点且成交量超过过去 M 期分位阈值
- 出场：回落到突破位下方 X% 或时间止损（K 期不达预期退出）
- 仓位：分批建仓，总仓位受组合回撤预算约束
- 失效条件：高换手但后续无持续成交量/波动率塌陷

#### S3 均值回归（适合震荡市；单边下跌易越抄越亏）
- 入场：偏离度/RSI 达阈值，同时下跌动能放缓
- 出场：回归到均线/RSI 中枢或硬止损
- 仓位：更保守，严格单票止损
- 失效条件：波动率上升且趋势增强（环境切换）

#### S4 公告事件驱动（适合明确事件；依赖结构化质量）
- 入场：事件抽取为结构化事实并满足规则，按 `market_effective_time` 生效
- 出场：事件窗口结束或触发风险阈值
- 仓位：按事件解析置信度分层设上限（不直接给方向）
- 失效条件：样本外衰减明显或解析置信度低

#### S5 组合层风险预算（稳定性护栏）
- 目标：降低波动与回撤，而非追求单次爆发
- 规则：Vol Targeting + 回撤预算分配 + 相关性惩罚（避免同涨同跌拥挤）

### 7.2 LLM 文本观点如何安全进入回测（禁止拍脑袋）
- 只允许“抽取事实/归类事件”进入回测；禁止直接用“利好/利空/看涨/看跌”主观标签驱动交易
- 每条结构化事件必须存：来源、许可标记、证据片段、解析置信度、解析版本、原文引用（可追溯）
- “规则生成”必须经过：结构化 → 特征化 → 模板参数化 → 回测验证 → 达标才可启用模拟盘

---

## 8. 回测引擎分级与 MVP 目标级别

### 8.1 回测分级标准
- L0（研究级）：下一根日 K 成交（简化撮合），固定成本，复权/停牌粗处理
- L1（实用级，推荐 MVP 目标）：日 K 撮合 + 限价/市价 + 成交失败处理；佣金/印花税/滑点；A 股关键细节（涨跌停、停牌、T+1、100 股整数倍、交易时段按日简化）
- L2（准实盘级）：分钟线撮合 + 量约束；更细滑点/冲击成本；更完整公司行动与集合竞价近似
- L3（机构级）：盘口/逐笔与排队模型（MVP 不做）

### 8.2 MVP 选择：L1
理由：在工程成本与可信度之间最均衡，能够支撑“验证模式”上线，避免 L0 过度理想化，同时不背负 L2 的工程负担。

---

## 9. 风控目标：最大回撤 ≤ 25% 的工程化实现

### 9.1 风控层设计（事前/事中/事后）
- 事前：标的过滤（停牌/ST/流动性不足/数据质量差）、单票/行业上限、波动率目标（钳住总风险）
- 事中：单票止损（基于 ATR/波动动态）、组合回撤熔断（分级减仓/清仓/冷静期）、再平衡纪律（固定频率减少噪声交易）
- 事后：收益归因（策略/因子/事件/情景）、执行偏差、数据质量问题定位

### 9.2 回测与模拟盘同口径
撮合、费用、风控必须共用同一套代码与配置模型；回测与模拟盘只切换“数据输入与时间推进方式”，不复制实现。

### 9.3 “稳定”的量化指标（默认门槛建议）
必须在全样本与样本外同时评估：
- MaxDD：全样本与样本外均 \( \le 25\% \)
- 滚动窗口：滚动 12 个月 MaxDD \( \le 20\% \)，滚动 36 个月 MaxDD \( \le 25\% \)
- 回撤修复：最长回撤修复时间（Time to Recovery）不超过阈值（按产品定位建议 9–12 个月）
- 收益质量：Calmar、Ulcer Index、CVaR(95%)、Tail Ratio
- 一致性：月度正收益比例、最差月/最差季度、亏损集中度（Top-3 亏损贡献占比）
- 可执行性：换手率上限、容量/冲击成本预警（成交额约束）

---

## 10. 系统架构与工程落地（结合现有前后端）

### 10.1 推荐技术栈（免费/省钱优先）
- 后端：继续 `Django + DRF` 作为主 API 与业务编排层
- 异步任务：`Celery + Redis`（分钟线更新、文本抓取、回测任务、指标预计算）
- 数据库：MVP 用 `PostgreSQL`（后续分钟线压力可考虑 TimescaleDB）
- LLM：DeepSeek（做强缓存、限流与成本控制）

### 10.2 模块划分（单体内分层，便于后续拆分）
- data_ingestion：行情/事件采集、幂等写入、质量标记
- market_data：统一读接口（图表/策略/回测共用）
- feature_engine：指标与特征计算（可缓存、可回放）
- event_engine：事件解析、实体链接、对齐到可交易时间
- strategy_engine：策略模板、参数、信号生成（可复现）
- risk_engine：风控（单票/组合）
- backtest_engine：回测运行器、撮合、成本、报告产物
- paper_trading：模拟盘账户/订单/成交/回放
- notification：告警（后续）
- audit：版本与可追溯（策略版本/解析版本/数据版本）

### 10.3 API 草案（MVP）
- `GET /api/instruments?search=`
- `GET /api/watchlists` / `POST /api/watchlists`
- `GET /api/market/bars?symbol=&tf=1d|1m&start=&end=`
- `GET /api/events?symbol=&start=&end=`
- `POST /api/llm/summarize`
- `GET /api/strategies/templates`
- `POST /api/backtests`
- `GET /api/backtests/{run_id}`
- `POST /api/paper/accounts/{id}/orders`
- `GET /api/paper/replay?account_id=&date=`

### 10.4 数据表草案（核心）
- instrument
- trading_calendar
- bar_1d, bar_1m（分区/索引：`(symbol, ts)`）
- corp_action / adj_factor
- event_doc（来源/许可/哈希）
- event_fact（结构化事实 + 证据片段 + 解析版本）
- signal（解释字段与引用）
- strategy, strategy_version
- backtest_run, backtest_trade, backtest_daily_nav
- paper_account, paper_order, paper_fill, paper_position

---

## 11. 模拟盘与执行（先模拟，后可扩展实盘）

### 11.1 MVP 模拟盘目标
- 事件驱动的模拟撮合：支持回放、逐步时间推进、订单/成交/持仓/风控事件全链路可审计
- 回测与模拟盘共享撮合/费用/风控代码，避免口径漂移

### 11.2 未来接券商/第三方交易接口的抽象层
- 定义统一接口：`BrokerAdapter`（下单、撤单、查询订单、查询成交、查询持仓、资金）
- 以事件总线驱动：策略信号 → 订单意图 → 风控审查 → 执行适配器 → 成交回报 → 账户状态更新
- 不绑定某一家实现：每家券商只实现 Adapter，核心逻辑不变

---

## 12. 过拟合与评估（最低可行自动化）
- 时间切分：训练/验证/样本外三段，严格只用过去调参
- Walk-forward（简化）：按季度/年度滚动优化，再在下一段验证
- 参数稳定性：参数扰动敏感性报告（热力图/局部梯度）
- 蒙特卡洛扰动：成交价噪声、滑点上调、信号延迟一根 bar、随机缺失部分数据，观察指标分布而非单点
- 产物要求：每次回测输出可复现配置（config）、报告（json）、图表与审计信息

---

## 13. 里程碑计划（从 0 到 1）

### Milestone A｜Web MVP（2–6 周）
- 投研台闭环：自选/个股页/事件流/信号解释/复盘
- 策略实验室：内置 3+ 模板，支持 L1 回测与样本外验证
- 风控硬约束：MaxDD \( \le 25\% \) 作为启用模拟盘的门槛

### Milestone B｜强化回测（4–10 周）
- 分钟线级撮合与更完整 A 股细节（涨跌停/停牌/集合竞价近似/冲击成本）
- 更完善的稳健性评估（walk-forward + 蒙特卡洛标准化流水线）

### Milestone C｜模拟盘（4–8 周）
- 事件驱动模拟撮合器、回放与复盘工具链、告警
- 为后续实盘预留 Adapter 抽象层

### Milestone D｜App → Milestone E｜小程序
- App：优先盯盘/告警/复盘，重交互投研台继续在 Web
- 小程序：轻量化自选与风险提示、复盘回看

---

## 14. 成本与免费优先方案
- 纯免费：本地/低配云主机 + PostgreSQL/Redis/Celery；文本以官方披露为主；LLM 强缓存与限流
- 极低成本：对象存储放冷数据；基础监控（开源或轻量 SaaS）
- 付费提升：更高质量且合规的数据源（行情/新闻/研报）、更强模型与 RAG、托管监控告警

